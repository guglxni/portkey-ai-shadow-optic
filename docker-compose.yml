# Docker Compose for Shadow-Optic Development
# Provides all required infrastructure services

version: "3.9"

services:
  # =========================================================================
  # Temporal Workflow Engine
  # =========================================================================
  
  temporal:
    image: temporalio/auto-setup:1.25
    container_name: shadow-optic-temporal
    ports:
      - "7233:7233"  # gRPC
    environment:
      - DB=postgres12
      - DB_PORT=5432
      - POSTGRES_USER=temporal
      - POSTGRES_PWD=temporal
      - POSTGRES_SEEDS=temporal-db
      - TEMPORAL_ADDRESS=0.0.0.0:7233
      - TEMPORAL_CLI_ADDRESS=temporal:7233
    depends_on:
      temporal-db:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "tctl namespace list 2>/dev/null || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 30s

  temporal-db:
    image: postgres:16
    container_name: shadow-optic-temporal-db
    environment:
      - POSTGRES_USER=temporal
      - POSTGRES_PASSWORD=temporal
      - POSTGRES_DB=temporal
    volumes:
      - temporal-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U temporal"]
      interval: 10s
      timeout: 5s
      retries: 5

  temporal-ui:
    image: temporalio/ui:2.31.0
    container_name: shadow-optic-temporal-ui
    ports:
      - "8080:8080"
    environment:
      - TEMPORAL_ADDRESS=temporal:7233
      - TEMPORAL_CORS_ORIGINS=http://localhost:3000
    depends_on:
      - temporal

  # =========================================================================
  # Qdrant Vector Database
  # =========================================================================
  
  qdrant:
    image: qdrant/qdrant:v1.12.0
    container_name: shadow-optic-qdrant
    ports:
      - "6333:6333"  # HTTP/REST
      - "6334:6334"  # gRPC
    volumes:
      - qdrant-data:/qdrant/storage
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
      - QDRANT__SERVICE__HTTP_PORT=6333
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/readyz"]
      interval: 30s
      timeout: 10s
      retries: 3

  # =========================================================================
  # Arize Phoenix Observability
  # =========================================================================
  
  phoenix:
    image: arizephoenix/phoenix:latest
    container_name: shadow-optic-phoenix
    ports:
      - "6006:6006"  # UI
      - "4317:4317"  # OTLP gRPC
    environment:
      - PHOENIX_WORKING_DIR=/mnt/data
    volumes:
      - phoenix-data:/mnt/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6006/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # =========================================================================
  # Shadow-Optic Worker
  # =========================================================================
  
  shadow-optic-worker:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: shadow-optic-worker
    command: python -m shadow_optic.worker
    environment:
      - TEMPORAL_ADDRESS=temporal:7233
      - TEMPORAL_NAMESPACE=shadow-optic
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - PHOENIX_COLLECTOR_ENDPOINT=http://phoenix:4317
      - PORTKEY_API_KEY=${PORTKEY_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    depends_on:
      temporal:
        condition: service_healthy
      qdrant:
        condition: service_healthy
    restart: unless-stopped
    volumes:
      - ./src:/app/src:ro
    healthcheck:
      test: ["CMD", "python", "-c", "import shadow_optic; print('ok')"]
      interval: 60s
      timeout: 10s
      retries: 3

  # =========================================================================
  # Shadow-Optic API Server
  # =========================================================================
  
  shadow-optic-api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: shadow-optic-api
    command: uvicorn shadow_optic.api:app --host 0.0.0.0 --port 8000
    ports:
      - "8000:8000"
    environment:
      - TEMPORAL_ADDRESS=temporal:7233
      - TEMPORAL_NAMESPACE=shadow-optic
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - PORTKEY_API_KEY=${PORTKEY_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    depends_on:
      temporal:
        condition: service_healthy
      qdrant:
        condition: service_healthy
    restart: unless-stopped
    volumes:
      - ./src:/app/src:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # =========================================================================
  # Monitoring Stack (Optional)
  # =========================================================================
  
  prometheus:
    image: prom/prometheus:v2.54.0
    container_name: shadow-optic-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    profiles:
      - monitoring

  grafana:
    image: grafana/grafana:11.3.0
    container_name: shadow-optic-grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./grafana/datasources:/etc/grafana/provisioning/datasources:ro
    profiles:
      - monitoring

# =============================================================================
# Volumes
# =============================================================================

volumes:
  temporal-db-data:
    driver: local
  qdrant-data:
    driver: local
  phoenix-data:
    driver: local
  prometheus-data:
    driver: local
  grafana-data:
    driver: local

# =============================================================================
# Networks
# =============================================================================

networks:
  default:
    name: shadow-optic-network
    driver: bridge
